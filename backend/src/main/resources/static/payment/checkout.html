<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>S2B 결제 위젯</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<div class="wrapper">
    <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
        <div id="payment-method"></div>

        <div id="agreement"></div>

        <button class="button" id="payment-button" style="margin-top: 30px">결제하기</button>
    </div>
</div>

<script>
    let paymentWidget;
    let currentOrderId;
    let currentOrderName;
    let currentCustomerEmail;
    let currentCustomerName;

    async function initPaymentWidget(clientKey, customerKey, orderId, orderName, amount, customerEmail, customerName) {
        try {
            // 데이터 저장
            currentOrderId = orderId;
            currentOrderName = orderName;
            currentCustomerEmail = customerEmail;
            currentCustomerName = customerName;

            // 1. SDK 초기화
            const tossPayments = TossPayments(clientKey);

            // 2. 위젯 생성 (회원 전용)
            const widgets = tossPayments.widgets({
                customerKey: customerKey
            });

            // 3. 금액 설정
            await widgets.setAmount({
                currency: "KRW",
                value: amount
            });

            // 4. 위젯 렌더링 (결제수단 + 이용약관)
            await Promise.all([
                widgets.renderPaymentMethods({
                    selector: "#payment-method",
                    variantKey: "DEFAULT"
                }),
                widgets.renderAgreement({
                    selector: "#agreement",
                    variantKey: "AGREEMENT"
                })
            ]);

            // 결제 객체 저장 (버튼 클릭 시 사용)
            paymentWidget = widgets;
            console.log("위젯 렌더링 완료");

        } catch (e) {
            console.error(e);
            alert("위젯 초기화 실패: " + e.message);
        }
    }

    // 결제하기 버튼 클릭
    document.getElementById("payment-button").addEventListener("click", async function () {
        if (!paymentWidget) {
            alert("결제 위젯이 준비되지 않았습니다.");
            return;
        }

        try {
            await paymentWidget.requestPayment({
                orderId: currentOrderId,
                orderName: currentOrderName,
                customerEmail: currentCustomerEmail,
                customerName: currentCustomerName,
                successUrl: window.location.origin + "/widget/success.html",
                failUrl: window.location.origin + "/fail.html",
            });
        } catch (error) {
            if (error.code !== "USER_CANCEL") {
                alert("결제 요청 실패: " + error.message);
            }
        }
    });
</script>
</body>
</html>