<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>S2B 결제</title>
    <style>
      body { font-family: sans-serif; padding: 20px; background-color: #f4f7f9; }
      .widget-container { background-color: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
      #payment-button { width: 100%; padding: 15px; font-size: 16px;
                        background-color: #007bff; color: white; border: none;
                        border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold; }
      #payment-button:hover { background-color: #0056b3; }
      /* 로딩 중일 때 버튼 비활성화 스타일 */
      #payment-button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>

    <script src="https://js.tosspayments.com/v2/payment-widget"></script>
  </head>
  <body>
    <div id="payment-widget" class="widget-container"></div>
    <div id="agreement" class="widget-container"></div>
    <button id="payment-button">결제하기</button>

    <script>
      let paymentWidget;
      let orderIdGlobal;
      let orderNameGlobal;
      let tossPayments;
      let retryCount = 0;
      const MAX_RETRY = 50; // 최대 5초 대기 (100ms * 50)

      function startPayment(clientKey, orderId, orderName, amount) {
        // [핵심] SDK가 로드되었는지 확인
        if (typeof TossPayments === 'undefined') {
          if (retryCount < MAX_RETRY) {
            console.log("SDK 로딩 대기 중... (" + retryCount + ")");
            retryCount++;
            // 0.1초 뒤에 다시 시도
            setTimeout(function() {
              startPayment(clientKey, orderId, orderName, amount);
            }, 100);
            return;
          } else {
            alert("인터넷 연결이 불안정하거나 Toss SDK를 불러올 수 없습니다.");
            return;
          }
        }

        // SDK 로드 완료됨 -> 로직 시작
        try {
          tossPayments = TossPayments(clientKey);

          paymentWidget = tossPayments.widgets({
            customerKey: TossPayments.ANONYMOUS
          });

          paymentWidget.setAmount({
              currency: "KRW",
              value: amount
          })
          .then(() => {
              return paymentWidget.renderPaymentMethods(
                "#payment-widget",
                { variantKey: "DEFAULT" }
              );
          })
          .then(() => {
              return paymentWidget.renderAgreement(
                  "#agreement",
                  { variantKey: "AGREEMENT" }
              );
          })
          .then(() => {
              console.log("위젯 렌더링 완료");
          })
          .catch((error) => {
              console.error(error);
              alert("위젯 렌더링 실패: " + error.message);
          });

          orderIdGlobal = orderId;
          orderNameGlobal = orderName;

        } catch (e) {
          alert("초기화 중 치명적 오류: " + e.message);
        }
      }

      document.getElementById("payment-button").addEventListener("click", function () {
        if (paymentWidget && orderIdGlobal) {
          paymentWidget.requestPayment({
            orderId: orderIdGlobal,
            orderName: orderNameGlobal,
            successUrl: "http://localhost:8080/api/v1/payments/success",
            failUrl: "http://localhost:8080/api/v1/payments/fail",
          }).catch(function (error) {
              if (error.code !== "USER_CANCEL") {
                alert("결제 실패: " + error.message);
              }
          });
        } else {
          alert("결제 위젯이 아직 준비되지 않았습니다. 잠시만 기다려주세요.");
        }
      });
    </script>
  </body>
</html>